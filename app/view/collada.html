<!DOCTYPE html>
<html>
	<head>
		<title>Throwing Dice Scene</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
		<script src="/js/three.js"></script>
		<script src="/js/physi.js"></script>
		<script src="/js/ColladaLoader2.js"></script>
	</head>
	<body>
	<div id="viewport"></div>
		<script>
			'use strict';
			
			Physijs.scripts.worker = '/js/physijs_worker.js';
			Physijs.scripts.ammo = '/js/ammo.js';

			var initScene, render, renderer, scene, camera, box;
			
			render = function() {
				if (renderer && scene && camera) {
					renderer.render( scene, camera); // render the scene
				}
				scene.simulate(); // run physics
				requestAnimationFrame( render );
			};			

			initScene = function() {
				renderer = new THREE.WebGLRenderer({ antialias: true });
				renderer.setSize( window.innerWidth, window.innerHeight);
				document.getElementById( 'viewport' ).appendChild( renderer.domElement );			
				
				scene = new Physijs.Scene;
				//scene = new THREE.Scene;
				scene.setGravity(new THREE.Vector3( 0, -35, 0 ));
				
				var loader = new THREE.ColladaLoader();
				loader.options.convertUpAxis = true;
				
				loader.load("/scene/cube-one.dae", function(collada) {
					var dae = collada.scene;
					dae.traverse(function(o) {
						if (o instanceof THREE.Camera) {
							camera = o;
						} else if (o.id == 28) {
							/*
							var loader = new THREE.TextureLoader();		
							var box_material = Physijs.createMaterial(
								new THREE.MeshLambertMaterial({ map: loader.load( '/images/plywood.jpg' ) }),
								.4, // low friction
								.6 // high restitution
							);
							
							var box = new Physijs.BoxMesh(
								//new THREE.BoxGeometry( 4, 4, 4 ),
								o.geometry,
								box_material
							);
							*/
						}
					});
					
					scene.add(dae);
					
					var loader = new THREE.TextureLoader();		
					var box_material = Physijs.createMaterial(
						new THREE.MeshLambertMaterial({ map: loader.load( '/images/plywood.jpg' ) }),
						.4, // low friction
						.6 // high restitution
					);						
					
					var box = new Physijs.BoxMesh(
							dae.children[2].children[1].geometry,
							box_material
						);
					scene.add(box);

					box.setLinearVelocity(new THREE.Vector3(0, 20, 0));
					box.setAngularVelocity(new THREE.Vector3(6, 7, -5));
					/*
					dae.traverse(function(o) {
						if (o instanceof THREE.Camera) {
							camera = o;
							scene.add(o);
						} else if (o instanceof THREE.Mesh) {

							var box_material = Physijs.createMaterial(
								//new THREE.MeshLambertMaterial({ map: loader.load( '/images/plywood.jpg' ) }),
								o.material,
								.4, // low friction
								.6 // high restitution
							);
							
							box = new Physijs.BoxMesh(
								//new THREE.BoxGeometry( 4, 4, 4 ),
								o.geometry,
								box_material
							);
							scene.add(box);
						}
					});
					*/
					//scene.add(dae);
				});				
				/*
				camera = new THREE.PerspectiveCamera(
					35,
					window.innerWidth / window.innerHeight,
					1,
					1000
				);
				camera.position.set( 60, 50, 60 );
				camera.lookAt( scene.position );
				scene.add( camera );
				*/
				
				/*
				var light = new THREE.DirectionalLight( 0xFFFFFF );
				light.position.set( 20, 100, -15 );
				light.target.position.copy( scene.position );				
				
				scene.add(light);
				*/
				
				
				
				// Loader
				var loader = new THREE.TextureLoader();				
				
				// Materials
				var ground_material = Physijs.createMaterial(
					new THREE.MeshLambertMaterial({ map: loader.load( '/images/rocks.jpg' ) }),
					.7, // high friction
					.7 // low restitution
				);
				ground_material.map.wrapS = ground_material.map.wrapT = THREE.RepeatWrapping;
				ground_material.map.repeat.set( 3, 3 );				
				/*
				var box_material = Physijs.createMaterial(
					new THREE.MeshLambertMaterial({ map: loader.load( '/images/plywood.jpg' ) }),
					.4, // low friction
					.6 // high restitution
				);
				box_material.map.wrapS = ground_material.map.wrapT = THREE.RepeatWrapping;
				box_material.map.repeat.set( .25, .25 );				
				
				box = new Physijs.BoxMesh(
					new THREE.BoxGeometry( 4, 4, 4 ),
					box_material
				);
				box.position.set(
					-25,
					15,
					-30
				);
				
				scene.add(box);				
				
				box.setLinearVelocity(new THREE.Vector3(15, 10, 17));
				box.setAngularVelocity(new THREE.Vector3(5, 3, 5));
				
				var box2 = new Physijs.BoxMesh(
					new THREE.BoxGeometry( 4, 4, 4 ),
					box_material
				);
				box2.position.set(
					-17,
					15,
					-35
				);
				
				scene.add(box2);	
				
				box2.setLinearVelocity(new THREE.Vector3(14, 15, 15));
				box2.setAngularVelocity(new THREE.Vector3(6, 7, -5));				
				*/
				
				// Ground
				var ground = new Physijs.BoxMesh(
					new THREE.BoxGeometry(100, 1, 100),
					ground_material,
					0 // mass
				);
				ground.receiveShadow = true;
				scene.add( ground );				
				

				requestAnimationFrame( render );
			};

			window.onload = initScene();			
		</script>
	</body>
</html>